# coinsec-doc

[数据脱敏](数据脱敏/README.md)
[服务器部署](部署.md)
[数据库迁移](数据库迁移.md)

## 一、环境与技术栈
### 1. 开发环境
- **操作系统**：Arch Linux（用于代码开发、数据库调试、本地功能测试）
- **开发工具**：
  - 后端框架：Spring Boot（Java）
  - 数据库：MariaDB（本地开发库，用于表结构设计与SQL调试）
  - 缓存：Valkey（本地开发环境，模拟缓存逻辑）
  - 构建工具：Maven/Gradle
  - 版本管理：Git（代码与SQL脚本版本控制）


### 2. 生产环境（阿里云ECS）
- **服务器配置**：实例规格 `ecs.e-c1m1.large`（2核2GiB）
- **操作系统**：Ubuntu Server 22.04 LTS（生态完善、长期支持，低维护成本）
- **部署架构**：单节点集成部署（非容器化，简化维护），组件包括：
  - MariaDB（核心数据存储）
  - Valkey（缓存高频数据：账户余额、预算进度、会话信息）
  - Spring Boot应用（后端服务，通过`systemd`管理，支持崩溃自动重启）
  - 轻量前端（可选，通过Python `http.server`临时提供静态页面访问）


## 二、数据库设计（完整表结构+核心规则）
[数据库设计](数据库设计/README.md)


## 三、核心业务逻辑（规则+流程）
### 1. 基础记账流程
- **数据流向**：用户输入（如“今天餐饮50元，微信支付”）→ 解析为`account_record`记录 → 生成`account_transaction`余额变动记录（更新账户余额）→ 同步更新`budget_execution`预算进度
- **金额计算**：支出记录（`type=1`）减少账户余额，收入记录（`type=2`）增加账户余额，余额变动原子性（通过`@Transactional`保证）


### 2. 关键业务规则
| 业务场景                | 确定规则                                                                 |
|-------------------------|--------------------------------------------------------------------------|
| 卡号/账号脱敏           | 银行卡：保留前4后4位（如`6222****0123`）；手机号：保留前3后4位（如`138****5678`）；邮箱：首字符+`****`+@+域名 |
| 逻辑删除                | 支持（`is_deleted=1`），删除时同步回滚账户余额、预算进度；支持误删恢复（取消删除标记+重新计算余额/预算） |
| 历史记录修改            | 允许修改1年内的记录，修改后同步更新：① 账户余额（基于新旧金额差额调整）；② 对应周期预算执行数据；③ 记录修改日志（`account_record_modify_log`） |
| 消费标签                | 支持用户自定义标签（如“加班餐”），一条记录可关联多个标签；支持标签维度查询（如“2024年9月加班餐支出”） |
| 预算控制                | 支持“总预算-子预算”层级（月度总预算拆分到餐饮/交通等类别），实时计算预算进度（已用金额/子预算金额），超支标记（`is_overspent=1`） |
| 转账功能                | 预留设计（`transfer_id`字段+`account_transfer`表），后期扩展时无需重构现有表结构 |


### 3. 对话式交互（基础支持）
- **上下文存储**：通过`conversation`表存储会话ID、最近记录ID、上下文JSON，设置过期时间（避免无效数据堆积）
- **核心能力**：支持基于历史上下文的操作（如“刚才那笔记录改金额为30元”），上下文解析依赖规则引擎（关键词匹配，个人场景无需轻量AI）


## 四、安全防护方案（双重保障）
### 1. ECS安全组配置
- **入方向规则**：仅允许服务器本机（`127.0.0.1/32`）访问核心端口，外部IP完全阻断：
  - 22端口（SSH）：仅本机访问（如需远程管理，临时添加个人本地IP，用完删除）
  - 8080端口（应用接口）：仅本机访问
  - 3306端口（MariaDB）：仅本机访问
  - 6379端口（Valkey）：仅本机访问
- **出方向规则**：默认允许所有（服务器需联网下载依赖、备份数据）


### 2. 应用与数据安全
- **接口鉴权**：使用Sa-Token实现登录认证+接口拦截：
  - 登录流程：用户输入账号密码→验证通过生成Token（有效期2小时）→后续请求需在Header携带`Authorization: Bearer Token`
  - 权限控制：仅允许用户ID=1（个人账号）访问，拦截未登录/无效Token请求
- **Valkey安全**：
  - 密码配置：通过`requirepass`设置强密码，Spring Boot应用同步配置密码
  - 持久化：启用RDB（每1小时生成快照，存储路径`/var/lib/valkey/dump.rdb`），避免缓存丢失
- **数据加密**：用户密码BCrypt加密，卡号脱敏存储，敏感配置（数据库密码、Valkey密码）通过环境变量注入（不硬编码）


## 五、运维与版本管理
### 1. 数据备份策略
- **数据库备份**：每日凌晨2点自动执行`backup.sh`脚本，备份`accounting`库到`/opt/accounting/backups`，保留最近30天备份
- **Valkey备份**：每日凌晨3点自动执行`valkey_backup.sh`脚本，备份RDB文件到`/opt/accounting/backups/valkey`，保留最近30天
- **备份验证**：每月1次手动检查备份文件（大小>0，可正常恢复）
[Valkey](数据库设计/Valkey.md)

### 2. 版本更新与回滚
[更新和回滚](更新和回滚/README.md)

### 3. 手动监控（每月1次）
[运维监控](运维监控/README.md)


## 六、未确定但明确扩展路径的内容
| 未确定项                | 扩展路径（后期按需落地）                                                                 |
|-------------------------|------------------------------------------------------------------------------------------|
| 前端技术栈              | 后期可选择Vue/React（Web端）或Flutter（移动端），当前暂用Python静态服务满足基础访问       |
| 账户间转账功能          | 基于预留的`transfer_id`字段和`account_transfer`表，新增转账主表+关联逻辑即可             |
| AA拆分功能              | 后期新增`aa_bill`（AA主表）+`aa_bill_detail`（AA明细），不影响现有记账流程               |
| 报表导出                | 新增Excel/PDF导出接口（基于EasyExcel），支持按时间/类别/标签筛选导出                     |