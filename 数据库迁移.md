### **一、数据库迁移方案（推荐Flyway）**
Flyway是Spring Boot官方推荐的数据库版本管理工具，特点是**配置简单、无侵入性**，适合个人项目快速上手。

#### 1. **核心原理**
- 通过**版本化的SQL脚本**管理数据库变更（如建表、加字段、初始化数据）。
- 应用启动时自动执行未执行过的脚本，确保开发/生产数据库结构一致。
- 记录脚本执行历史（存储在`flyway_schema_history`表），避免重复执行。


#### 2. **集成步骤（Spring Boot项目）**
##### （1）添加依赖（`pom.xml`）
```xml
<dependency>
    <groupId>org.flywaydb</groupId>
    <artifactId>flyway-core</artifactId>
</dependency>
<!-- 兼容MariaDB -->
<dependency>
    <groupId>org.flywaydb</groupId>
    <artifactId>flyway-mysql</artifactId>
</dependency>
```

##### （2）配置Flyway（`application.yml`）
```yaml
spring:
  flyway:
    enabled: true  # 启用Flyway
    baseline-on-migrate: true  # 首次运行时自动创建历史表
    baseline-version: 0  # 基准版本号
    clean-disabled: true  # 禁止生产环境执行clean（避免误删数据）
    locations: classpath:db/migration  # 脚本存放路径
    # 数据库连接信息（开发/生产通过profile区分）
    url: jdbc:mariadb://localhost:3306/accounting
    user: ${DB_USER}  # 从环境变量读取，避免硬编码
    password: ${DB_PASSWORD}
```

##### （3）编写迁移脚本
在项目`src/main/resources/db/migration`目录下按规则命名脚本：  
- 格式：`V{版本号}__{描述}.sql`（双下划线分隔，版本号递增）  
- 示例：  
  ```
  V1__init_tables.sql  # 初始化10张核心表
  V2__add_account_index.sql  # 给account表加索引
  V3__init_default_categories.sql  # 插入默认消费类别
  ```

  **脚本内容示例（V3__init_default_categories.sql）**：
  ```sql
  INSERT INTO `category` (name, type, sort) VALUES 
  ('餐饮', 1, 1), ('交通', 1, 2), ('购物', 1, 3),
  ('工资', 2, 1), ('兼职', 2, 2);
  ```


#### 3. **开发→生产迁移流程**
1. **开发环境**：  
   - 本地开发时，修改数据库结构后，新建对应版本的SQL脚本（如`V4__add_budget_remark.sql`）。  
   - 启动应用，Flyway自动执行脚本，更新本地MariaDB。  

2. **生产环境**：  
   - 部署前，确保所有脚本已提交到代码仓库（如Git）。  
   - 上传新版本jar包到阿里云ECS，启动应用。  
   - Flyway自动检测生产库的`flyway_schema_history`表，执行未执行的脚本（如`V4`），完成数据库更新。  


#### 4. **回滚策略（个人场景简化版）**
Flyway社区版不支持自动回滚，个人使用可手动处理：  
- 若脚本有误，新建一个“修复脚本”（如`V5__fix_v4_error.sql`），通过SQL语句修正（如`ALTER TABLE ... DROP COLUMN`）。  
- 重要操作前备份生产库（借助之前的`backup.sh`脚本），确保可恢复。  


### **二、配置文件管理（多环境隔离，无需Spring Cloud Config）**
个人项目无需引入Spring Cloud Config（太重），推荐使用**Spring Boot多环境配置 + 环境变量注入**，简单高效。

#### 1. **配置文件结构**
在`src/main/resources`下创建3类配置文件：  
```
resources/
├─ application.yml          # 公共配置（不区分环境）
├─ application-dev.yml      # 开发环境（Arch Linux）配置
└─ application-prod.yml     # 生产环境（阿里云ECS）配置
```

##### （1）公共配置（`application.yml`）
```yaml
spring:
  profiles:
    active: dev  # 默认启用开发环境
  datasource:
    driver-class-name: org.mariadb.jdbc.Driver
  redis:
    lettuce:
      pool:
        max-active: 8  # 连接池大小（公共配置）

# 应用端口（公共）
server:
  port: 8080
```

##### （2）开发环境配置（`application-dev.yml`）
```yaml
spring:
  datasource:
    url: jdbc:mariadb://localhost:3306/accounting_dev  # 本地开发库
    username: root  # 本地数据库用户（无需保密）
    password: 123456  # 本地密码
  redis:
    host: localhost  # 本地Valkey
    port: 6379

# 开发环境日志级别（调试用）
logging:
  level:
    root: INFO
    com.accounting: DEBUG  # 打印SQL语句
```

##### （3）生产环境配置（`application-prod.yml`）
```yaml
spring:
  datasource:
    url: jdbc:mariadb://localhost:3306/accounting  # 生产库
    username: ${DB_USER}  # 从环境变量读取（避免硬编码密码）
    password: ${DB_PASSWORD}
  redis:
    host: localhost  # 生产环境Valkey
    port: 6379

# 生产环境日志级别（减少输出）
logging:
  level:
    root: WARN
    com.accounting: INFO
  file:
    name: /opt/accounting/logs/app.log  # 日志输出到文件
```


#### 2. **敏感信息处理（密码、密钥）**
- **生产环境**：通过**环境变量**注入敏感信息，不在配置文件中明文存储。  
  在阿里云ECS上启动应用时，通过命令传递环境变量：  
  ```bash
  # 启动脚本（start.sh）中添加环境变量
  export DB_USER=account_user
  export DB_PASSWORD=你的生产库密码
  nohup java -Xms512m -Xmx512m -jar accounting.jar --spring.profiles.active=prod > app.log 2>&1 &
  ```

- **开发环境**：本地密码可直接写在`application-dev.yml`（仅本地可见，不提交到仓库）。  


#### 3. **配置切换方式**
- 开发时：默认使用`application-dev.yml`（通过`spring.profiles.active=dev`）。  
- 部署到生产时：通过启动参数`--spring.profiles.active=prod`切换到生产配置。  


### **三、完整迁移流程（开发→生产）**
1. **本地开发与测试**：  
   - 在Arch Linux中开发功能，编写代码和Flyway脚本。  
   - 本地启动应用（默认dev环境），测试功能和数据库迁移是否正常。  
   - 提交代码和脚本到Git仓库（如`git commit -m "add budget feature"`）。  

2. **生产环境部署准备**：  
   - 登录阿里云ECS，拉取最新代码（或通过`scp`上传打包好的jar包）。  
   - 确保生产库已初始化（首次部署时手动创建数据库`accounting`）。  

3. **执行迁移与启动**：  
   - 上传jar包到`/opt/accounting`目录。  
   - 执行启动脚本（`./start.sh`），通过`--spring.profiles.active=prod`启用生产配置。  
   - 应用启动时，Flyway自动执行未执行的SQL脚本，完成数据库迁移。  
   - 检查日志（`tail -f app.log`），确认启动成功。  


### **四、方案优势**
1. **轻量易维护**：无需额外部署中间件（如Config Server），适合个人项目。  
2. **版本可控**：Flyway脚本与代码同步管理，避免“开发库和生产库结构不一致”问题。  
3. **环境隔离**：通过profiles区分开发/生产配置，敏感信息通过环境变量注入，安全可靠。  
4. **可扩展性**：未来如需多人协作或更复杂的环境，可平滑过渡到Spring Cloud Config或GitOps方案。